import{j as a}from"./react-jsx-runtime-BBsywpoz.js";import{r as l}from"./react-core-KcGD0Z1V.js";import{X as _,P as R}from"./icons-chunk-AVFeydwE.js";const F=()=>{if(typeof window>"u")return"https://allinbangla.com/api";const n=window.location.hostname,t=window.location.protocol;if(n==="localhost"||n==="127.0.0.1"||n.endsWith(".localhost"))return"http://localhost:5001/api";const e=n.split("."),r=e.length>2?e.slice(-2).join("."):n;return`${t}//${r}/api`},H=()=>{if(typeof window>"u")return null;const t=window.location.hostname.split(".");if(t.length>2){const e=t[0];if(e!=="www"&&e!=="admin"&&e!=="superadmin")return e;if(e==="admin"){const o=new URLSearchParams(window.location.search).get("tenant");if(o)return o}}return null},d=F(),b="admin_auth_token",j="admin_auth_user",N="admin_auth_permissions",u=()=>{const n=localStorage.getItem(b);return n?{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}:{"Content-Type":"application/json"}},h=async(n,t=!1)=>{const e=await n.json().catch(()=>({}));if(!n.ok){if(n.status===401&&t&&(localStorage.removeItem(b),localStorage.removeItem(j),localStorage.removeItem(N)),e.error&&Array.isArray(e.error)){const o=e.error.map(i=>i.message).join(", ");throw new Error(o)}const r=typeof e.error=="string"?e.error:e.message||`HTTP Error ${n.status}`;throw new Error(r)}return e},W=async(n,t)=>{const e=H(),r=await fetch(`${d}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json",...e&&{"X-Tenant-Subdomain":e}},body:JSON.stringify({email:n,password:t,...e&&{subdomain:e}})}),o=await h(r);return localStorage.setItem(b,o.token),localStorage.setItem(j,JSON.stringify(o.user)),localStorage.setItem(N,JSON.stringify(o.permissions||[])),o},G=()=>{localStorage.removeItem(b),localStorage.removeItem(j),localStorage.removeItem(N)},V=async()=>{const n=await fetch(`${d}/auth/me`,{headers:u()}),t=await h(n);return localStorage.setItem(j,JSON.stringify(t.user)),localStorage.setItem(N,JSON.stringify(t.permissions||[])),t},M=async()=>{const n=await fetch(`${d}/auth/admin/users`,{headers:u()});return(await h(n)).users},q=async n=>{const t=await fetch(`${d}/auth/admin/users`,{method:"POST",headers:u(),body:JSON.stringify(n)});return(await h(t)).user},Q=async(n,t)=>{const e=await fetch(`${d}/auth/admin/users/${n}`,{method:"PUT",headers:u(),body:JSON.stringify(t)});return(await h(e)).user},Z=async n=>{const t=await fetch(`${d}/auth/admin/users/${n}`,{method:"DELETE",headers:u()});await h(t)},ee=async(n,t)=>{const r=(await M()).find(p=>p.email===n);if(!r)throw new Error(`User with email ${n} not found`);const o=await fetch(`${d}/auth/admin/users/${r._id||r.id}/role`,{method:"PATCH",headers:u(),body:JSON.stringify({roleId:t})}),i=await h(o);return i.data||i.user},te=async()=>{const n=await fetch(`${d}/auth/admin/roles`,{headers:u()}),t=await h(n);return t.data||t.roles||[]},re=async n=>{const t=await fetch(`${d}/auth/admin/roles`,{method:"POST",headers:u(),body:JSON.stringify(n)}),e=await h(t);return e.data||e.role},ae=async(n,t)=>{const e=await fetch(`${d}/auth/admin/roles/${n}`,{method:"PUT",headers:u(),body:JSON.stringify(t)}),r=await h(e);return r.data||r.role},ne=async n=>{const t=await fetch(`${d}/auth/admin/roles/${n}`,{method:"DELETE",headers:u()});await h(t)},se=()=>{const n=localStorage.getItem(b);if(!n)return!1;try{return JSON.parse(atob(n.split(".")[1])).exp*1e3>Date.now()}catch{return!1}},oe=()=>{const n=localStorage.getItem(j);return n?JSON.parse(n):null},ie=()=>{const n=localStorage.getItem(N);return n?JSON.parse(n):[]},m=()=>{if(typeof window<"u"){const n=window.location.hostname;if(n!=="localhost"&&n!=="127.0.0.1")return window.location.origin}return import.meta?.env?.VITE_API_BASE_URL||"http://localhost:5001"},z=()=>typeof window<"u"&&(localStorage.getItem("activeTenantId")||localStorage.getItem("tenantId")||localStorage.getItem("tenant_id"))||"";class Y{constructor(){this.tenantIdOverride=null}setTenantId(t){this.tenantIdOverride=t,typeof window<"u"&&t&&localStorage.setItem("activeTenantId",t)}getEffectiveTenantId(){return this.tenantIdOverride||z()}getHeaders(){const t=this.getEffectiveTenantId();return console.log("[DueListService] Using tenant ID:",t),{"Content-Type":"application/json","X-Tenant-Id":t,...u()}}async getEntities(t,e){try{const r=new URLSearchParams;t&&r.append("type",t),e&&r.append("search",e);const o=await fetch(`${m()}/api/entities${r.toString()?`?${r}`:""}`,{headers:this.getHeaders()});if(!o.ok){const i=await o.json().catch(()=>({}));throw new Error(i.error||"Failed to fetch entities")}return await o.json()}catch(r){throw console.error("Error fetching entities:",r),r}}async getEntity(t){try{const e=await fetch(`${m()}/api/entities/${t}`,{headers:this.getHeaders()});if(!e.ok){const r=await e.json().catch(()=>({}));throw new Error(r.error||"Failed to fetch entity")}return await e.json()}catch(e){throw console.error("Error fetching entity:",e),e}}async createEntity(t){try{const e=await fetch(`${m()}/api/entities`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(t)});if(!e.ok){const r=await e.json().catch(()=>({}));throw new Error(r.error||"Failed to create entity")}return await e.json()}catch(e){throw console.error("Error creating entity:",e),e}}async updateEntity(t,e){try{const r=await fetch(`${m()}/api/entities/${t}`,{method:"PUT",headers:this.getHeaders(),body:JSON.stringify(e)});if(!r.ok){const o=await r.json().catch(()=>({}));throw new Error(o.error||"Failed to update entity")}return await r.json()}catch(r){throw console.error("Error updating entity:",r),r}}async deleteEntity(t){try{const e=await fetch(`${m()}/api/entities/${t}`,{method:"DELETE",headers:this.getHeaders()});if(!e.ok){const r=await e.json().catch(()=>({}));throw new Error(r.error||"Failed to delete entity")}return await e.json()}catch(e){throw console.error("Error deleting entity:",e),e}}async getTransactions(t,e,r,o){try{const i=new URLSearchParams;t&&i.append("entityId",t),e&&i.append("from",e),r&&i.append("to",r),o&&i.append("status",o);const p=await fetch(`${m()}/api/transactions${i.toString()?`?${i}`:""}`,{headers:this.getHeaders()});if(!p.ok){const g=await p.json().catch(()=>({}));throw new Error(g.error||"Failed to fetch transactions")}return await p.json()}catch(i){throw console.error("Error fetching transactions:",i),i}}async getTransaction(t){try{const e=await fetch(`${m()}/api/transactions/${t}`,{headers:this.getHeaders()});if(!e.ok){const r=await e.json().catch(()=>({}));throw new Error(r.error||"Failed to fetch transaction")}return await e.json()}catch(e){throw console.error("Error fetching transaction:",e),e}}async createTransaction(t){try{const e=await fetch(`${m()}/api/transactions`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(t)});if(!e.ok){const r=await e.json().catch(()=>({}));throw new Error(r.error||"Failed to create transaction")}return await e.json()}catch(e){throw console.error("Error creating transaction:",e),e}}async updateTransactionStatus(t,e){try{const r=await fetch(`${m()}/api/transactions/${t}`,{method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({status:e})});if(!r.ok){const o=await r.json().catch(()=>({}));throw new Error(o.error||"Failed to update transaction")}return await r.json()}catch(r){throw console.error("Error updating transaction:",r),r}}async deleteTransaction(t){try{const e=await fetch(`${m()}/api/transactions/${t}`,{method:"DELETE",headers:this.getHeaders()});if(!e.ok){const r=await e.json().catch(()=>({}));throw new Error(r.error||"Failed to delete transaction")}return await e.json()}catch(e){throw console.error("Error deleting transaction:",e),e}}}const P=new Y,ce=({isOpen:n,onClose:t,onSave:e})=>{const[r,o]=l.useState(null),[i,p]=l.useState([]),[g,I]=l.useState(null),[$,k]=l.useState(""),[O,E]=l.useState(!1),[A,C]=l.useState(!1),[f,S]=l.useState({name:"",phone:""}),[c,v]=l.useState({amount:"",dueDate:new Date().toISOString().split("T")[0],collectionDate:"",notes:""}),[w,x]=l.useState({}),T=l.useRef(null);if(l.useEffect(()=>{r&&(async()=>{try{const y=r==="INCOME"?"Customer":"Supplier",L=await P.getEntities(y);p(L)}catch(y){console.error("Error fetching entities:",y)}})()},[r]),l.useEffect(()=>{const s=y=>{T.current&&!T.current.contains(y.target)&&E(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]),!n)return null;const U=async()=>{if(!f.name||!f.phone){x({entity:"Please fill in name and phone"});return}try{const s=await P.createEntity({name:f.name,phone:f.phone,type:r==="INCOME"?"Customer":"Supplier"});p([...i,s]),I(s),S({name:"",phone:""}),C(!1),x({})}catch(s){x({entity:"Error creating entity: "+s.message})}},J=()=>{const s={};if(r||(s.direction="Please select transaction type"),g||(s.entity="Please select an entity"),(!c.amount||parseFloat(c.amount)<=0)&&(s.amount="Please enter a valid amount"),c.dueDate||(s.date="Please select a due date"),Object.keys(s).length>0){x(s);return}const y={entityId:g._id||"",entityName:g.name,amount:parseFloat(c.amount),direction:r,transactionDate:c.dueDate,dueDate:c.collectionDate||void 0,notes:c.notes||void 0};e(y)},D=i.filter(s=>s.name.toLowerCase().includes($.toLowerCase())||s.phone.includes($));return a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:a.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto",children:[a.jsxs("div",{className:"sticky top-0 bg-white p-4 sm:p-6 pb-4 flex items-center justify-between border-b border-gray-100",children:[a.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Add New Due"}),a.jsx("button",{onClick:t,className:"p-1 hover:bg-gray-100 rounded-lg transition",children:a.jsx(_,{size:20,className:"text-gray-500"})})]}),a.jsx("div",{className:"p-6 space-y-6",children:r?a.jsxs(a.Fragment,{children:[a.jsx("button",{onClick:()=>{o(null),I(null),x({})},className:"text-theme-primary text-sm font-medium hover:underline",children:"← Change transaction type"}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700",children:r==="INCOME"?"Customer":"Supplier"}),a.jsxs("div",{className:"relative",ref:T,children:[a.jsx("button",{onClick:()=>E(!O),className:"w-full px-4 py-3 border border-gray-300 rounded-lg text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-600",children:g?a.jsx("span",{className:"text-gray-900",children:g.name}):"Select or search..."}),O&&a.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10",children:[a.jsx("input",{type:"text",placeholder:"Search by name or phone...",value:$,onChange:s=>k(s.target.value),className:"w-full px-4 py-2 border-b border-gray-200 focus:outline-none",autoFocus:!0}),a.jsx("div",{className:"max-h-48 overflow-y-auto",children:D.length===0?a.jsxs("div",{className:"p-4 text-center text-gray-500 text-sm",children:["No ",r==="INCOME"?"customers":"suppliers"," found"]}):D.map(s=>a.jsxs("button",{onClick:()=>{I(s),E(!1),k("")},className:"w-full px-4 py-2 text-left hover:bg-gray-50 transition border-b border-gray-100 last:border-b-0",children:[a.jsx("p",{className:"font-medium text-gray-900",children:s.name}),a.jsx("p",{className:"text-sm text-gray-600",children:s.phone})]},s._id))}),a.jsxs("button",{onClick:()=>{C(!0),E(!1)},className:"w-full px-4 py-2 text-theme-primary font-medium hover:bg-theme-primary/10 transition border-t border-gray-200 flex items-center justify-center gap-2",children:[a.jsx(R,{size:16})," Add New"]})]})]}),w.entity&&a.jsx("p",{className:"text-sm text-red-600",children:w.entity})]}),A&&a.jsxs("div",{className:"space-y-3 p-4 bg-gray-50 rounded-lg border border-gray-200",children:[a.jsx("input",{type:"text",placeholder:"Name",value:f.name,onChange:s=>S({...f,name:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"}),a.jsx("input",{type:"tel",placeholder:"Phone",value:f.phone,onChange:s=>S({...f,phone:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{onClick:U,className:"flex-1 px-3 py-2 btn-theme-primary rounded-lg transition font-medium",children:"Add"}),a.jsx("button",{onClick:()=>{C(!1),S({name:"",phone:""})},className:"flex-1 px-3 py-2 bg-gray-300 text-gray-900 rounded-lg hover:bg-gray-400 transition font-medium",children:"Cancel"})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Amount (in ৳)"}),a.jsx("input",{type:"number",min:"0",step:"0.01",value:c.amount,onChange:s=>v({...c,amount:s.target.value}),placeholder:"0",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"}),w.amount&&a.jsx("p",{className:"text-sm text-red-600",children:w.amount})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Due Date"}),a.jsx("input",{type:"date",value:c.dueDate,onChange:s=>v({...c,dueDate:s.target.value}),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"}),w.date&&a.jsx("p",{className:"text-sm text-red-600",children:w.date})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Due Collection Date (Optional)"}),a.jsx("input",{type:"date",value:c.collectionDate,onChange:s=>v({...c,collectionDate:s.target.value}),placeholder:"mm/dd/yyyy",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Details/Notes"}),a.jsx("textarea",{value:c.notes,onChange:s=>v({...c,notes:s.target.value}),placeholder:"e.g., Invoice #101 for 5kg coffee beans",maxLength:500,className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none h-24 bg-white"})]}),a.jsxs("div",{className:"flex gap-3 pt-6",children:[a.jsx("button",{onClick:t,className:"flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium",children:"Cancel"}),a.jsx("button",{onClick:J,disabled:!g||!c.amount,className:"flex-1 px-4 py-3 text-blue-600 font-medium rounded-lg hover:bg-blue-50 transition disabled:opacity-50 disabled:cursor-not-allowed",children:"Save Transaction"})]})]}):a.jsxs("div",{className:"space-y-3",children:[a.jsx("label",{className:"block text-sm font-semibold text-gray-700",children:"Transaction Type"}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("button",{onClick:()=>o("INCOME"),className:"w-full p-4 border-2 border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 transition text-left",children:[a.jsx("p",{className:"font-semibold text-gray-900",children:"You Will Get"}),a.jsx("p",{className:"text-sm text-gray-600",children:"Money owed by a customer"})]}),a.jsxs("button",{onClick:()=>o("EXPENSE"),className:"w-full p-4 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition text-left",children:[a.jsx("p",{className:"font-semibold text-gray-900",children:"You Will Give"}),a.jsx("p",{className:"text-sm text-gray-600",children:"Money owed to a supplier"})]})]})]})})]})})};export{ce as A,M as a,te as b,ne as c,P as d,ae as e,re as f,u as g,Z as h,se as i,Q as j,q as k,oe as l,ie as m,G as n,V as o,W as p,ee as u};
